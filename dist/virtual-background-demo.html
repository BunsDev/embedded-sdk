<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <!--  <script src="https://unpkg.com/@digitalsamba/embedded-sdk"></script>-->
  <script src="./umd/index.js"></script>
  <style>
    .user-list-row {
      display: flex;
      margin-bottom: 8px;
      align-items: center;
    }

    .user-list-avatar {
      width: 24px;
      height: 24px;
      display: block;
      border-radius: 50%;
      margin-right: 8px;
    }

    .log p {
      font-size: 14px;
      line-height: 1;
      margin: 0 0 4px
    }

    .buttons button, .captions-buttons button {
      margin: 2px;
    }
  </style>
  <script>
    const initialRoomState = {
      username: "",
      micEnabled: false,
      cameraEnabled: false,
      showToolbar: false,
      showCaptions: false,
      layoutMode: 'auto',
      virtualBackground: undefined
    }
    const VBstate = {
      type: 'blur',
      value: 'balanced',
      enforce: false,
    }
    const updateVBEnabled = () => {
      const vbOptions = document.querySelector('.vb-prep-options');

      if(initialRoomState.virtualBackground) {
        initialRoomState.virtualBackground = undefined
        vbOptions.style.opacity = '0.5'
        vbOptions.style.pointerEvents = 'none'
      } else {
        initialRoomState.virtualBackground = VBstate;
        vbOptions.style.opacity = '1'
        vbOptions.style.pointerEvents = 'all'
      }
    }
  </script>
</head>
<body>
<div>
  <p>allowed blur options: "balanced", "strong"</p>
  <p>allowed image options: "office","office2","beach","fireworks","bookshelf","forest","mountain","savannah"
  </p>
</div>
<div class="sdk-prep">
  <h3>Initial settings</h3>

  <label for="prep-username-input">
    <p>Username:</p>
    <input type="text" id="prep-username-input">
  </label>
  <div class="prep-checkboxes"></div>
  <fieldset>
    <legend>Layout mode:</legend>
    <div>
      <input type="radio" id="prep-layout-mode1" checked name="contact" value="auto" onchange="initialRoomState.layoutMode = 'auto'" />
      <label for="prep-layout-mode1">Auto</label>

      <input type="radio" id="contactChoice2" name="contact" value="tiled" onchange="initialRoomState.layoutMode = 'tiled'"/>
      <label for="contactChoice2">Tiled</label>
    </div>
  </fieldset>
  <fieldset>
    <legend>Virtual background:</legend>
    <input type="checkbox" id="prep-vb-enabled" name="vb-enabled" value="auto" onchange="updateVBEnabled()" />
    <label for="prep-vb-enabled">VB enabled</label>
    <div class="vb-prep-options" style="opacity: 0.5; pointer-events: none;">
      <div>
        <label for="vb-type">VB type</label>
        <select name="vb-type" id="vb-type" onchange="VBstate.type = this.value">
          <option value="blur">blur</option>
          <option value="image">image</option>
          <option value="imageUrl">imageUrl</option>
        </select>
      </div>
      <div>
        <label for="prep-vb-value"></label>
        <input type="text" name="prep-vb-value" id="prep-vb-value" value="balanced" onchange="VBstate.value = this.value">
      </div>
      <div>
        <input type="checkbox" id="prep-vb-enforced" name="vb-enforced" value="auto" onchange="VBstate.enforce = !VBstate.enforce" />
        <label for="prep-vb-enforced">enforce VB</label>
      </div>
    </div>
  </fieldset>
  <div style="margin-top: 20px">
    <button type="button" class="sdk-prep-submit">load</button>
  </div>
</div>
<div class="sdk-ready" style="display: none">
  <div style="display: flex">
    <div class="ifp">

    </div>
    <div style="min-width: 300px ; padding: 0 16px">
      <h3>Room state</h3>
      <div class="state">

      </div>
    </div>
  </div>
  <div class="div buttons" style=" border: 1px solid yellow">
    <button class="c0" style="margin-right: 15px; border: 2px solid blue">LOAD</button>

    <fieldset>
      <legend>Virtual background:</legend>
      <div class="vb-room-options">
        <div>
          <label for="room-vb-type">VB type</label>
          <select name="room-vb-type" id="room-vb-type" onchange="VBstate.type = this.value">
            <option value="blur">blur</option>
            <option value="image">image</option>
            <option value="imageUrl">imageUrl</option>
          </select>
        </div>
        <div>
          <label for="room-vb-value"></label>
          <input type="text" name="room-vb-value" id="room-vb-value" value="balanced" onchange="VBstate.value = this.value">
        </div>
        <div>
          <input type="checkbox" id="room-vb-enforced" name="room-vb-enforced" value="auto" onchange="VBstate.enforce = !VBstate.enforce" />
          <label for="room-vb-enforced">enforce VB</label>
        </div>
      </div>
    </fieldset>
    <button class="enable-vb-button">apply settings</button>
    <button class="disable-vb-button">disable-vb</button>
  </div>

  <div class="log">

  </div>
</div>

<script async defer>
  const parent = document.querySelector('.ifp');
  const frame = document.querySelector('.if');
  const buttonsParent = document.querySelector('.buttons');
  const captionsButtonsParent = document.querySelector('.captions-buttons');
  const participantList = document.querySelector('.participants');
  const btn0 = document.querySelector('.c0');
  const prepButton = document.querySelector('.sdk-prep-submit');
  const prepBlock = document.querySelector('.sdk-prep')
  const controlsBlock = document.querySelector('.sdk-ready')
  const prepUsernameInput = document.getElementById('prep-username-input')
  const prepCheckboxesParent = document.querySelector('.prep-checkboxes')

  const enableVBButton = document.querySelector('.enable-vb-button')
  const disableVBButton = document.querySelector('.disable-vb-button')

  // change these values to connect to your room
  const TEAM = 'some-team';
  const ROOM = 'some-room';
  let ROOM_URL = 'https://localhost:3000/Public'

  if(window.location.search) {
    const params = new URLSearchParams(window.location.search);
    const dynamicRoomUrl = params.get('roomUrl');
    if(dynamicRoomUrl) {
      ROOM_URL = dynamicRoomUrl
    }
  }

  //const api = new DigitalSambaEmbedded({ root: parent, team: TEAM, room: ROOM});
  // const api = new DigitalSambaEmbedded({ frame});
  //const api = new DigitalSambaEmbedded({ url: ROOM_URL}, {reportErrors: true});

  const prepCheckboxes = [
    {control: 'micEnabled', label: 'Microphone enabled  by default'},
    {control: 'cameraEnabled', label: 'Camera enabled  by default'},
    {control: 'showToolbar', label: 'Show toolbar'},
    {control: 'showCaptions', label: 'Show captions'},
  ];

  prepCheckboxes.forEach(control => {
    const label = document.createElement('label');
    label.style.display = 'block'
    label.htmlFor = 'prep-' + control.control;
    label.innerHTML = '<span>' + control.label + '</span>'


    const field = document.createElement('input');
    field.type = 'checkbox';
    field.id = 'prep-' + control.control;

    field.onchange = (e) => {
      initialRoomState[control.control] = e.target.checked
    }

    label.appendChild(field);
    prepCheckboxesParent.appendChild(label)

  })

  prepButton.onclick = () => {
    prepBlock.style.display = 'none'
    controlsBlock.style.display = 'block'

    createControl()
  }

  prepUsernameInput.onchange = (e) => {
    initialRoomState.username = e.target.value
  }

  const vbStateToInitState = (originalConfig) => {
    if(!originalConfig) return undefined;

    return {
      [originalConfig.type]: originalConfig.value,
      enforce: originalConfig.enforce
    }
  }

  const createControl = () => {
    initialRoomState.virtualBackground = vbStateToInitState(initialRoomState.virtualBackground)

    const api = DigitalSambaEmbedded.createControl({ url: ROOM_URL, root: parent, roomSettings: initialRoomState });

    const log = document.querySelector('.log');

    api.frame.width = 900;
    api.frame.height = 700;

    btn0.onclick = () => {api.load({ frameAttributes: {style: "border: 5px solid red"}, reportErrors: true })}

    api.on('*', (data) => {
      log.innerHTML += `<p>${Number(new Date)}: ev(${data?.type}): ${JSON.stringify(data)}</p>`
    });

    const stateBlock = document.querySelector('.state');

    api.on('roomStateUpdated', ({data}) => {
      stateBlock.innerHTML = JSON.stringify(data);
    })

    enableVBButton.onclick = () => {
      console.warn(vbStateToInitState(VBstate),'---')
      api.configureVirtualBackground(vbStateToInitState(VBstate));
    }

    disableVBButton.onclick = () => {
      api.disableVirtualBackground()
    }

  }

</script>

</body>
</html>
